<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smooth Reader — 5-Minute Fluency Lab</title>
  <meta name="description" content="A tiny, kid-friendly fluency practice site: rhyme, tongue twister, echo, chunking, performance." />
  <style>
    :root{
      --bg:#0b0f1a;
      --text:#eaf0ff;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff;
      --accent2:#35d3ff;
      --good:#2fe59a;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(53,211,255,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(47,229,154,.12), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:1100px; margin:0 auto; padding:22px 18px 34px;}

    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }

    .brand{display:flex; gap:12px; align-items:center;}

    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 220deg, var(--accent), var(--accent2), var(--good), var(--accent));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-20%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 35%);
      transform: rotate(15deg);
    }

    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:12.5px}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }

    label{font-size:12px; color:var(--muted)}

    select{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding:9px 10px;
      outline:none;
      font-family:var(--sans);
    }

    button{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(124,92,255,.28), rgba(124,92,255,.12));
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .08s ease, filter .15s ease;
      font-family:var(--sans);
    }

    button:hover{filter:brightness(1.06)}
    button:active{transform: translateY(1px)}

    button.secondary{background: rgba(255,255,255,.04);}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      margin-top: 14px;
    }

    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }

    .titleRow{display:flex; align-items:center; gap:10px}
    .badge{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }

    .step{
      padding: 14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .step h2{
      margin:0;
      font-size:15px;
      display:flex; align-items:center; gap:8px;
    }

    .hint{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .practiceText{
      font-size: 22px;
      line-height: 1.35;
      letter-spacing: .2px;
      padding: 14px 14px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      white-space: pre-line;
    }

    .practiceText.big{font-size: 28px}

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}

    .miniBtns{display:flex; flex-wrap:wrap; gap:8px}

    .icon{
      width:18px; height:18px; display:inline-grid; place-items:center;
      border-radius: 6px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 7px;
      border-radius: 10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--muted);
    }

    .progressWrap{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.14);
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
      flex:1;
    }

    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--good));
      border-radius: 999px;
      transition: width .25s ease;
    }

    .timer{
      font-family: var(--mono);
      font-size: 12.5px;
      color: var(--muted);
      min-width: 110px;
      text-align:right;
    }

    .sidebar{
      padding: 14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }

    .panel h3{margin:0 0 6px; font-size: 13px}
    .panel p{margin:0; color:var(--muted); font-size: 12.5px; line-height:1.4}

    .toggle{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding: 10px 12px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }

    .toggle input{width:18px; height:18px}

    .footerNote{color: var(--muted); font-size: 12px; margin-top: 10px; opacity: .9;}

    .chunks{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      padding: 12px;
      border-radius: var(--radius2);
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      margin-top: 8px;
    }

    .chunk{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 16px;
    }

    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(16,26,43,.92);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: min(680px, calc(100vw - 28px));
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px)}
    .toast small{color:var(--muted)}

    /* Tiny test report (hidden unless failure) */
    #testReport{
      display:none;
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: min(420px, calc(100vw - 32px));
      background: rgba(16,26,43,.96);
      border: 1px solid rgba(255,120,120,.35);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
      color: var(--text);
      z-index: 50;
    }
    #testReport b{color: #ffb3b3;}
    #testReport pre{white-space: pre-wrap; margin:8px 0 0; color: var(--muted); font-size: 12px;}
  </style>
</head>
<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Smooth Reader <span class="badge" id="difficultyBadge">Medium</span></h1>
          <p class="sub">A 5-minute fluency loop: rhythm → clarity → chunks → performance.</p>
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <label for="difficulty">Difficulty</label>
          <select id="difficulty" aria-label="Choose difficulty">
            <option value="1">Easy</option>
            <option value="2" selected>Medium</option>
            <option value="3">Hard</option>
          </select>
        </div>

        <button id="newSet" title="Generate a new daily set (N)">
          <span class="icon">N</span> New set
        </button>
        <button id="start" class="secondary" title="Start / pause the 5-minute timer (Space)">
          <span class="icon">␣</span> Start
        </button>
      </div>
    </header>

    <div class="grid">

      <section class="card" aria-label="Practice steps">
        <div class="cardHead">
          <div>
            <div class="titleRow">
              <span class="badge">Daily loop</span>
              <span class="badge">3–5 minutes</span>
              <span class="badge">No scores</span>
            </div>
            <div class="hint" style="margin-top:8px;">
              Tip: The goal is <b>smooth</b>, not fast. Try 2–3 reads per step.
              <span class="kbd">N</span> new set · <span class="kbd">→</span> next · <span class="kbd">←</span> back · <span class="kbd">Space</span> start/pause
            </div>
          </div>
          <div class="badge" id="stepBadge">Step 1 / 5</div>
        </div>

        <div id="steps"></div>

        <div class="progressWrap">
          <div class="bar" aria-label="progress"><i id="barFill"></i></div>
          <div class="timer" id="timer">05:00</div>
        </div>
      </section>

      <aside class="card" aria-label="Coach panel">
        <div class="cardHead">
          <div>
            <div class="titleRow">
              <span class="badge">Coach</span>
              <span class="badge">Adult optional</span>
            </div>
            <div class="hint" style="margin-top:8px;">Everything stays on-device. No scores. Just smooth reading.</div>
          </div>
        </div>

        <div class="sidebar">
          <div class="toggle">
            <div>
              <b>Big text</b>
              <div class="hint">Larger print for confidence.</div>
            </div>
            <input id="bigText" type="checkbox" />
          </div>

          <div class="panel">
            <h3>How to prompt a smoother read</h3>
            <p>
              • “Read it like you’re telling me something.”<br>
              • “Group words that belong together.”<br>
              • “Try again—same speed, smoother.”
            </p>
          </div>

          <div class="panel">
            <h3>What this trains</h3>
            <p>
              <b>Rhythm</b> · <b>Articulation</b> · <b>Prosody</b> · <b>Phrasing</b> · <b>Confidence</b>
            </p>
          </div>

          <div class="footerNote">
            Single-file site. Save as <span class="kbd">smooth-reader.html</span> and open in any browser.
          </div>
        </div>
      </aside>

    </div>

  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div id="testReport" role="alert"></div>

  <!-- Lightweight global error reporter: runs even if the large script fails to parse -->
  <script>
    (function(){
      function showReport(title, detail){
        const r = document.getElementById('testReport');
        if(r){
          r.style.display = 'block';
          r.innerHTML = '<b>' + (title || 'Error') + '</b><pre>' + (detail || '') + '</pre>';
        } else {
          // Fallback: alert so developer notices.
          try { alert((title ? title + ': ' : '') + (detail || '')); } catch(e){}
        }
      }
      window.addEventListener('error', function(e){
        const detail = (e.error && (e.error.stack || e.error)) ? (e.error.stack || e.error) : (e.message || String(e));
        showReport('Runtime error', detail);
      });
      window.addEventListener('unhandledrejection', function(e){
        const reason = e && e.reason ? (e.reason.stack || e.reason) : String(e);
        showReport('Unhandled promise rejection', reason);
      });
    })();
  </script>

  <script>
  // Drop-in replacement script with strong safety + on-screen error reporting.
  (function(){
    const POOLS = {
      1: {
        rhymes: [
          `Tap tap tap
On my desk
Read the words
Do your best
Slow then smooth
Keep the beat
Make your reading
Sound so neat`,
          `One two three
Here we go
Not too fast
Not too slow
Pause and breathe
Then you see
Smooth reading
Feels easy`,
          `Clap clap clap
Soft and light
Read the line
Just right
Try again
Same calm pace
Put a smile
On your face`,
          `I read a line
I read it through
I keep it smooth
So can you
I pause a bit
Then I go
Like a steady
Little flow`,
          `Tick tock tick
Like a clock
Words roll on
Like a rock
Stop at the dot
Start anew
Smooth all the way
Through and through`
        ],
        twisters: [
          "Tiny turtles tap toes.",
          "Silly snakes sip soup.",
          "Busy bunnies bounce balls.",
          "Dizzy dogs dig dirt.",
          "Happy hens hop home."
        ],
        echoSentences: [
          "The sun is up and warm.",
          "My dog ran to the gate.",
          "We went up the big hill.",
          "The cat sat by the door.",
          "I read the whole sentence."
        ],
        chunkSentences: [
          "After school / we drew pictures / on big paper.",
          "In the morning / I found / a shiny rock.",
          "At the park / we ran / and we laughed.",
          "Before dinner / I washed / my hands.",
          "On my desk / I placed / my book."
        ],
        performanceLines: [
          "I can do hard things.",
          "This story is fun to read.",
          "I can try again.",
          "I read with my talking voice.",
          "I can read it smooth and steady."
        ]
      },
      2: {
        rhymes: [
          `The moon wore socks
The socks wore shoes
The shoes went dancing
And forgot their blues`,
          `A pancake flipped
And said oh wow
It landed proud
On a plate ker-pow`,
          `My pencil wrote
A silly joke
It made the eraser
Laugh and choke`,
          `A cloud sat down
On a windy day
It yawned a yawn
And blew away`,
          `The mailbox sang
A rusty tune
It hummed it softly
Under the moon`
        ],
        twisters: [
          "Lazy lions lick lemons.",
          "Five funny fish flip fast.",
          "Benny's blue boat bumps bumps.",
          "Sandy skates in sunny streets.",
          "Piper picks purple peppers."
        ],
        echoSentences: [
          "The dog trotted home with a proud grin.",
          "A bright kite tugged at the string.",
          "We packed snacks and hurried to the park.",
          "The storm passed, and the air felt new.",
          "I paused at the comma, then kept going."
        ],
        chunkSentences: [
          "After lunch / we cleaned our tables / and lined up.",
          "On Saturday / my sister and I / built a fort.",
          "In the dark forest / an owl / watched quietly.",
          "Before the game / the coach / gave us a plan.",
          "At the library / I chose / a mystery book."
        ],
        performanceLines: [
          "I did not rush; I read it smoothly.",
          "This part sounds exciting when I add feeling.",
          "I can read this like I am talking to a friend.",
          "I will try it again, same speed, smoother.",
          "My voice can sound like a storyteller."
        ]
      },
      3: {
        rhymes: [
          `I step to the beat
One two one two
I read it smooth
And so can you
I pause then flow
Like a steady drum
My words stay together
They do not come undone`,
          `Tap tap tap
On the table top
Read the line
And do not stop
Breathe at the comma
Hold the pace
Let every word
Fall into place`,
          `Left foot right foot
March in time
Read the words
And make them rhyme
Not too fast
Not too slow
Keep it smooth
And let it go`,
          `Clap the beat
Soft and neat
Keep your voice
Calm and sweet
If you miss
Try again
Smooth reading
Wins the end`,
          `Drum on your knees
Boom boom bam
Read it like
A story jam
Stretch the long words
Snap the short
Smooth and steady
Is the sport`,
          `Tick tock tick tock
Like a clock
Words roll by
Like a rock
Pause at the dot
Then start anew
Same calm speed
All the way through`,
          `Under the moon
We read a tune
Not in a rush
Not too soon
We group the words
That belong
Then read it
Like a song`,
          `Zip zip zoom
But not too fast
Make the sentence
Truly last
Hold the meaning
In your mind
Smooth the bumps
You always find`,
          `Here is the trick
For tricky text
Read the phrase
Then read the next
Keep your rhythm
Steady true
The story sounds
Brand new to you`,
          `One breath in
One breath out
Keep the beat
And lose the doubt
Read the line
With gentle swing
Smooth reading
Is your thing`
        ],
        twisters: [
          "Greedy green geese gobble grapes.",
          "Tricky trains travel through thick tunnels.",
          "Crisp crackers crack in crowded crates.",
          "Seven silver swans swiftly swim south.",
          "Witty witches whisper with white whistles."
        ],
        echoSentences: [
          "Even when I stumble, I can recover and continue.",
          "Because the path was steep, we rested halfway up.",
          "While the crowd cheered, the runner stayed focused.",
          "After the surprise ending, I reread the clue.",
          "When my voice matches the mood, the story feels real."
        ],
        chunkSentences: [
          "When the bell rang / we grabbed our notebooks / and hurried inside.",
          "At the edge of the field / the tall grass / swayed in waves.",
          "If I slow down / at the tricky word / the sentence will make sense.",
          "Because the wind was strong / the kite pulled / against my hands.",
          "After the rain stopped / puddles reflected / the bright sky."
        ],
        performanceLines: [
          "I can change my tone to match the mood of the story.",
          "I will pause at punctuation and keep my phrases together.",
          "I can emphasize important words without speeding up.",
          "I will keep my voice smooth, even on long sentences.",
          "I can read this like I am presenting to an audience."
        ]
      }
    };

    function $(sel){ return document.querySelector(sel); }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function poemToHtml(s){
      // Supports both real newlines and literal "\\n" sequences.
      const safe = escapeHtml(String(s == null ? "" : s));
      // Turn literal backslash-n sequences into real newlines, then convert newlines to <br>.
      const normalized = safe.replaceAll("\\n", "\n");
      return normalized.replaceAll("\n", "<br>");
    }

    function showFatal(msg, err){
      const steps = $("#steps");
      if(steps){
        steps.innerHTML = "<div class=\"step\"><div class=\"hint\"><b>Something went wrong:</b> " + escapeHtml(msg) + "</div>" +
          "<div class=\"practiceText\" style=\"font-family: var(--mono); font-size: 13px; line-height: 1.35;\">" +
          escapeHtml(String(err && (err.stack || err) ? (err.stack || err) : "")) +
          "</div></div>";
      }
      console.error(msg, err);
    }

    // Global error hooks so you never get a silent blank UI.
    window.addEventListener("error", function(e){
      showFatal("Runtime error", e.error || e.message);
    });
    window.addEventListener("unhandledrejection", function(e){
      showFatal("Unhandled promise rejection", e.reason);
    });

    const state = {
      level: 2,
      set: null,
      stepIndex: 0,
      bigText: false,
      timer: { total: 300, remaining: 300, running: false, handle: null }
    };

    function rand(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function buildSet(level){
      const pool = POOLS[level];
      if(!pool) throw new Error("Missing pool for level: " + level);
      if(!pool.rhymes || pool.rhymes.length === 0) throw new Error("No rhymes for level: " + level);
      return {
        level: level,
        rhyme: rand(pool.rhymes),
        twister: rand(pool.twisters),
        echo: rand(pool.echoSentences),
        chunk: rand(pool.chunkSentences),
        perf: rand(pool.performanceLines)
      };
    }

    function parseChunks(s){
      return String(s || "").split("/").map(x => x.trim()).filter(Boolean);
    }

    function fmtTime(sec){
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function setTimerText(){
      const timerEl = $("#timer");
      const barFill = $("#barFill");
      if(timerEl) timerEl.textContent = fmtTime(state.timer.remaining);
      if(barFill){
        const pct = ((state.timer.total - state.timer.remaining) / state.timer.total) * 100;
        barFill.style.width = String(Math.max(0, Math.min(100, pct))) + "%";
      }
    }

    function stopTimer(){
      state.timer.running = false;
      if(state.timer.handle) window.clearInterval(state.timer.handle);
      state.timer.handle = null;
      const startBtn = $("#start");
      if(startBtn) startBtn.innerHTML = '<span class="icon">␣</span> Start';
    }

    function toggleTimer(){
      if(state.timer.running){
        stopTimer();
        return;
      }
      state.timer.running = true;
      const startBtn = $("#start");
      if(startBtn) startBtn.innerHTML = '<span class="icon">␣</span> Pause';
      state.timer.handle = window.setInterval(() => {
        state.timer.remaining = Math.max(0, state.timer.remaining - 1);
        setTimerText();
        if(state.timer.remaining === 0) stopTimer();
      }, 1000);
    }

    function resetTimer(){
      stopTimer();
      state.timer.remaining = state.timer.total;
      setTimerText();
    }

    function setDifficultyBadge(){
      const b = $("#difficultyBadge");
      if(!b) return;
      b.textContent = state.level === 1 ? "Easy" : (state.level === 2 ? "Medium" : "Hard");
    }

    function render(){
      const stepsEl = $("#steps");
      const stepBadge = $("#stepBadge");
      if(!stepsEl) throw new Error("Missing #steps element in HTML");
      if(!state.set) throw new Error("No set loaded");

      const chunks = parseChunks(state.set.chunk);

      // Build step data with plain TEXT (not HTML) to avoid rendering/escaping issues.
      const steps = [
        {
          title: "Fresh rhyme",
          icon: "M",
          why: "Find a beat (tap/clap). Read it 3 times: (1) slow, (2) on the beat, (3) same beat - smoother.",
          text: (state.set.rhyme == null ? "" : String(state.set.rhyme)),
          isPoem: true,
          actions: [{ kind:"tip", label:"Tip", tip:"Beat tip", sub:"Keep a steady 1-2-3-4. Same beat each repeat." }]
        },
        {
          title: "Tongue twister",
          icon: "T",
          why: "Whisper -> normal -> smooth. Do not race; connect the sounds.",
          text: (state.set.twister == null ? "" : String(state.set.twister)),
          isPoem: false,
          actions: [{ kind:"tip", label:"Tip", tip:"Mouth tip", sub:"Relax your jaw. Smooth wins." }]
        },
        {
          title: "Echo reading",
          icon: "E",
          why: "Adult reads once. Student echoes with the same rhythm and pauses.",
          text: (state.set.echo == null ? "" : String(state.set.echo)),
          isPoem: false,
          actions: [{ kind:"tip", label:"Tip", tip:"Echo tip", sub:"Match pauses like copying a melody." }]
        },
        {
          title: "Phrase chunking",
          icon: "C",
          why: "Read chunks first, then read the whole sentence smoothly.",
          text: (state.set.chunk == null ? "" : String(state.set.chunk)),
          isPoem: false,
          actions: [{ kind:"toggleChunks", label:"Show chunks" }],
          chunks: chunks
        },
        {
          title: "Performance read",
          icon: "P",
          why: "Read it like: robot -> storyteller -> best smooth voice.",
          text: (state.set.perf == null ? "" : String(state.set.perf)),
          isPoem: false,
          actions: [{ kind:"tip", label:"Ideas", tip:"Performance", sub:"Try: robot (flat), calm teacher, excited announcer." }]
        }
      ];

      const active = steps[state.stepIndex];

      // Clear
      stepsEl.innerHTML = "";

      // Article
      const article = document.createElement("article");
      article.className = "step";

      // Row
      const row = document.createElement("div");
      row.className = "row";

      const h2 = document.createElement("h2");
      const iconSpan = document.createElement("span");
      iconSpan.className = "icon";
      iconSpan.setAttribute("aria-hidden","true");
      iconSpan.textContent = active.icon;
      h2.appendChild(iconSpan);
      h2.appendChild(document.createTextNode(" " + active.title));

      const btnWrap = document.createElement("div");
      btnWrap.className = "miniBtns";

      // Buttons
      (active.actions || []).forEach(a => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = (a.kind === "toggleChunks") ? "" : "secondary";
        b.textContent = a.label;
        b.addEventListener("click", () => {
          if(a.kind === "toggleChunks"){
            const el = $("#chunks");
            if(!el) return;
            el.style.display = (el.style.display === "none") ? "flex" : "none";
          }
          if(a.kind === "tip"){
            // Minimal: no toast dependency here; keep stable.
          }
        });
        btnWrap.appendChild(b);
      });

      row.appendChild(h2);
      row.appendChild(btnWrap);

      // Why
      const why = document.createElement("div");
      why.className = "hint";
      why.textContent = active.why + "  (debug: len=" + String((active.text || "").length) + ")";

      // Practice text
      const practice = document.createElement("div");
      practice.className = "practiceText" + (state.bigText ? " big" : "");
      practice.setAttribute("role","group");
      practice.setAttribute("aria-label","Practice text");

      // Normalize literal "\\n" sequences into real newlines, then rely on CSS pre-line.
      const normalized = String(active.text || "").replaceAll("\\n", "\n");
      const finalText = (normalized && normalized.trim().length) ? normalized : "[No text loaded - check POOLS + buildSet]";
      practice.textContent = finalText;
      // Force visibility in case of CSS collisions
      practice.style.color = "var(--text)";
      practice.style.whiteSpace = "pre-line";

      article.appendChild(row);
      article.appendChild(why);
      article.appendChild(practice);

      // Optional chunks panel
      if(active.chunks){
        const chunkBox = document.createElement("div");
        chunkBox.className = "chunks";
        chunkBox.id = "chunks";
        chunkBox.style.display = "none";
        chunkBox.setAttribute("aria-label","Chunked phrase tiles");
        active.chunks.forEach(c => {
          const pill = document.createElement("span");
          pill.className = "chunk";
          pill.textContent = c;
          chunkBox.appendChild(pill);
        });
        article.appendChild(chunkBox);
      }

      stepsEl.appendChild(article);

      if(stepBadge) stepBadge.textContent = "Step " + String(state.stepIndex + 1) + " / 5";
    }

    function newSet(){ 
      state.set = buildSet(state.level);
      state.stepIndex = 0;
      resetTimer();
      render();
    }

    function nextStep(){ state.stepIndex = Math.min(4, state.stepIndex + 1); render(); }
    function prevStep(){ state.stepIndex = Math.max(0, state.stepIndex - 1); render(); }

    function init(){
      // Verify required DOM exists
      const required = ["#steps", "#difficulty", "#newSet", "#start", "#bigText", "#difficultyBadge", "#timer", "#barFill", "#stepBadge"]; 
      required.forEach(sel => { if(!$(sel)) throw new Error("Missing required element: " + sel); });

      $("#difficulty").addEventListener("change", (e) => {
        state.level = Number(e.target.value);
        setDifficultyBadge();
        newSet();
      });

      $("#bigText").addEventListener("change", (e) => {
        state.bigText = !!e.target.checked;
        render();
      });

      $("#newSet").addEventListener("click", newSet);
      $("#start").addEventListener("click", toggleTimer);

      window.addEventListener("keydown", (e) => {
        if(e.target && ["INPUT","SELECT","TEXTAREA"].includes(e.target.tagName)) return;
        // Support multiple representations of the space key across browsers.
        if(e.code === "Space" || e.key === " " || e.key === "Spacebar"){ e.preventDefault(); toggleTimer(); }
        else if(e.key === "ArrowRight") nextStep();
        else if(e.key === "ArrowLeft") prevStep();
        else if(e.key.toLowerCase() === "n") newSet();
      });

      state.level = Number($("#difficulty").value);
      setDifficultyBadge();
      setTimerText();
      newSet();
    }

    try{ init(); }
    catch(err){ showFatal("Initialization failed", err); }
  })();
  </script>
</body>
</html>